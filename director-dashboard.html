<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë LIBRUZ - Panel Dyrektora</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: white;
            height: 100vh;
            padding: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            overflow-y: auto;
        }
        .content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }
        
        .logo {
            color: #007bff;
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .menu {
            list-style: none;
        }
        .menu-item {
            padding: 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .menu-item:hover {
            background: #007bff;
            color: white;
        }
        .menu-item.active {
            background: #007bff;
            color: white;
            font-weight: bold;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            margin: 5px;
        }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; }
        .btn-secondary { background: #6c757d; }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card h3 {
            margin-top: 0;
            color: #007bff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .col { flex: 1; }
        
        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: block;
            width: 100%;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .wizard {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .wizard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .wizard-step {
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 1;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        .step-circle.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        .step-circle.completed {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        .step-title {
            font-size: 12px;
            color: #666;
        }
        
        .wizard-content {
            min-height: 300px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .wizard-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-primary { background: #007bff; color: white; }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: black; }
        
        .subject-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 3px;
            font-size: 13px;
        }
        
        .timetable {
            width: 100%;
            border-collapse: collapse;
        }
        .timetable th, .timetable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            vertical-align: top;
        }
        .timetable th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .lesson-cell {
            min-height: 60px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .lesson-cell:hover {
            background: #f0f8ff;
        }
        .lesson-cell.empty {
            background: #f9f9f9;
        }
        .lesson-cell.has-lesson {
            background: #e7f7ef;
            border-left: 3px solid #28a745;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
        }
        
        .login-list {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .login-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .login-item:last-child {
            border-bottom: none;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üëë LIBRUZ Director</div>
        
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">JD</div>
            <h4 id="userName">Jan Dyrektor</h4>
            <p style="color: #666; font-size: 14px;">Szko≈Ça Podstawowa nr 1</p>
            <div class="badge badge-primary" style="margin-top: 10px;">Dyrektor</div>
        </div>
        
        <ul class="menu">
            <li class="menu-item active" onclick="showSection('dashboard')">
                üìä Pulpit
            </li>
            <li class="menu-item" onclick="showSection('teachers')">
                üë• Nauczyciele
            </li>
            <li class="menu-item" onclick="showSection('classes')">
                üè´ Klasy
            </li>
            <li class="menu-item" onclick="showSection('students')">
                üë¶ Uczniowie
            </li>
            <li class="menu-item" onclick="showSection('timetable')">
                üïí Plan lekcji
            </li>
            <li class="menu-item" onclick="showSection('subjects')">
                üìö Przedmioty
            </li>
            <li class="menu-item" onclick="showSection('messages')">
                üí¨ Wiadomo≈õci
            </li>
            <li class="menu-item" onclick="showSection('settings')">
                ‚öôÔ∏è Ustawienia
            </li>
        </ul>
        
        <button class="btn btn-danger" style="width: 100%; margin-top: 30px;" onclick="logout()">
            üö™ Wyloguj
        </button>
        
        <div style="margin-top: 30px; font-size: 12px; color: #999; text-align: center;">
            LIBRUZ v2.0<br>
            ¬© 2024 System Szkolny
        </div>
    </div>
    
    <div class="content">
        <div id="dashboardSection" class="section">
            <div class="card">
                <h3>üëã Witaj w panelu dyrektora!</h3>
                <p>U≈ºyj menu po lewej stronie, aby zarzƒÖdzaƒá szko≈ÇƒÖ.</p>
                
                <div class="row" style="margin-top: 20px;">
                    <div class="col">
                        <div class="card" style="text-align: center; background: #e7f7ef;">
                            <h4 style="color: #28a745;">üë• Nauczyciele</h4>
                            <h2 id="teachersCount">0</h2>
                            <p>zatrudnionych</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card" style="text-align: center; background: #e7f3ff;">
                            <h4 style="color: #007bff;">üè´ Klasy</h4>
                            <h2 id="classesCount">0</h2>
                            <p>aktywnych klas</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card" style="text-align: center; background: #fff3cd;">
                            <h4 style="color: #ffc107;">üë¶ Uczniowie</h4>
                            <h2 id="studentsCount">0</h2>
                            <p>w systemie</p>
                        </div>
                    </div>
                </div>
                
                <div id="setupWizard" class="wizard" style="display: none;">
                    <div class="wizard-header">
                        <h3>üéØ Konfiguracja szko≈Çy - Krok po kroku</h3>
                        <p>Wype≈Çnij wszystkie kroki, aby skonfigurowaƒá szko≈Çƒô</p>
                    </div>
                    
                    <div class="wizard-steps">
                        <div class="wizard-step">
                            <div class="step-circle" id="step1">1</div>
                            <div class="step-title">Nauczyciele</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-circle" id="step2">2</div>
                            <div class="step-title">Klasy</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-circle" id="step3">3</div>
                            <div class="step-title">Uczniowie</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-circle" id="step4">4</div>
                            <div class="step-title">Plan lekcji</div>
                        </div>
                        <div class="wizard-step">
                            <div class="step-circle" id="step5">5</div>
                            <div class="step-title">Gotowe</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="setupProgress" style="width: 20%;"></div>
                    </div>
                    
                    <div class="wizard-content" id="wizardContent">
                        <!-- Zawarto≈õƒá krok√≥w bƒôdzie tu ≈Çadowana -->
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()">‚Üê Wstecz</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Dalej ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="card">
                        <h3>üìÖ Najbli≈ºsze wydarzenia</h3>
                        <div id="eventsList">
                            <p>Brak nadchodzƒÖcych wydarze≈Ñ</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <h3>‚ö° Szybkie akcje</h3>
                        <button class="btn btn-primary" onclick="showSection('teachers')" style="width: 100%; margin-bottom: 10px;">
                            ‚ûï Dodaj nauczyciela
                        </button>
                        <button class="btn btn-success" onclick="showSection('classes')" style="width: 100%; margin-bottom: 10px;">
                            üè´ Dodaj klasƒô
                        </button>
                        <button class="btn btn-warning" onclick="showSection('timetable')" style="width: 100%;">
                            üïí Edytuj plan lekcji
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sekcja nauczycieli -->
        <div id="teachersSection" class="section" style="display: none;">
            <div class="card">
                <h3>üë• ZarzƒÖdzanie nauczycielami</h3>
                
                <div class="row">
                    <div class="col">
                        <h4>Dodaj nowego nauczyciela</h4>
                        <form id="addTeacherForm" onsubmit="addTeacher(event)">
                            <input type="text" id="teacherFirstName" placeholder="Imiƒô *" required>
                            <input type="text" id="teacherLastName" placeholder="Nazwisko *" required>
                            <input type="email" id="teacherEmail" placeholder="Email s≈Çu≈ºbowy *" required>
                            <select id="teacherSubjects" multiple style="height: 120px;">
                                <option value="matematyka">Matematyka</option>
                                <option value="polski">Jƒôzyk polski</option>
                                <option value="angielski">Jƒôzyk angielski</option>
                                <option value="historia">Historia</option>
                                <option value="biologia">Biologia</option>
                                <option value="chemia">Chemia</option>
                                <option value="fizyka">Fizyka</option>
                                <option value="geografia">Geografia</option>
                                <option value="wf">Wychowanie fizyczne</option>
                                <option value="informatyka">Informatyka</option>
                            </select>
                            <small>Przytrzymaj Ctrl, aby wybraƒá kilka przedmiot√≥w</small>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                <h5>Wygenerowane dane:</h5>
                                <p><strong>Login:</strong> <span id="generatedLogin">-</span></p>
                                <p><strong>Tymczasowe has≈Ço:</strong> <span id="generatedPassword">Nauczyciel2024!</span></p>
                            </div>
                            
                            <button type="submit" class="btn btn-success">‚ûï Dodaj nauczyciela</button>
                        </form>
                    </div>
                    
                    <div class="col">
                        <h4>Lista nauczycieli</h4>
                        <div class="table-container">
                            <table id="teachersTable">
                                <thead>
                                    <tr>
                                        <th>Imiƒô i nazwisko</th>
                                        <th>Przedmioty</th>
                                        <th>Login</th>
                                        <th>Status</th>
                                        <th>Akcje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamicznie ≈Çadowane -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sekcja klas -->
        <div id="classesSection" class="section" style="display: none;">
            <div class="card">
                <h3>üè´ ZarzƒÖdzanie klasami</h3>
                
                <div class="row">
                    <div class="col">
                        <h4>Dodaj nowƒÖ klasƒô</h4>
                        <form id="addClassForm" onsubmit="addClass(event)">
                            <div class="row">
                                <div class="col">
                                    <select id="classLevel" required>
                                        <option value="">Poziom *</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="1lo">1 LO</option>
                                        <option value="2lo">2 LO</option>
                                        <option value="3lo">3 LO</option>
                                        <option value="4lo">4 LO</option>
                                        <option value="1ttk">1 TTK</option>
                                        <option value="2ttk">2 TTK</option>
                                        <option value="3ttk">3 TTK</option>
                                        <option value="4ttk">4 TTK</option>
                                        <option value="5ttk">5 TTK</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <input type="text" id="classPrefix" placeholder="Prefiks (np. A, B, C)">
                                </div>
                            </div>
                            
                            <select id="classHomeroom">
                                <option value="">Wybierz wychowawcƒô</option>
                                <option value="">Brak wychowawcy</option>
                                <!-- Dynamicznie ≈Çadowani nauczyciele -->
                            </select>
                            
                            <div style="margin: 15px 0;">
                                <label><strong>Wybierz przedmioty:</strong></label>
                                <div id="classSubjectsList" style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <!-- Dynamicznie ≈Çadowane przedmioty -->
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success">‚ûï Dodaj klasƒô</button>
                        </form>
                    </div>
                    
                    <div class="col">
                        <h4>Lista klas</h4>
                        <div class="table-container">
                            <table id="classesTable">
                                <thead>
                                    <tr>
                                        <th>Klasa</th>
                                        <th>Wychowawca</th>
                                        <th>Liczba uczni√≥w</th>
                                        <th>Przedmioty</th>
                                        <th>Akcje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamicznie ≈Çadowane -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sekcja uczni√≥w -->
        <div id="studentsSection" class="section" style="display: none;">
            <div class="card">
                <h3>üë¶ ZarzƒÖdzanie uczniami</h3>
                
                <div class="row">
                    <div class="col">
                        <h4>Dodaj uczni√≥w</h4>
                        <div class="form-group">
                            <label>Wybierz klasƒô:</label>
                            <select id="studentClassSelect" onchange="loadClassStudents()">
                                <option value="">-- Wybierz klasƒô --</option>
                            </select>
                        </div>
                        
                        <div id="addStudentArea">
                            <p>Wybierz klasƒô, aby dodaƒá uczni√≥w</p>
                        </div>
                        
                        <div id="bulkAddStudents" style="display: none;">
                            <h5>Dodaj wielu uczni√≥w naraz</h5>
                            <textarea id="studentsBulk" placeholder="Wpisz uczni√≥w w formacie:
Imiƒô Nazwisko
Jan Kowalski
Anna Nowak
..." rows="5" style="width: 100%;"></textarea>
                            <button class="btn btn-primary" onclick="bulkAddStudents()">Dodaj uczni√≥w</button>
                        </div>
                    </div>
                    
                    <div class="col">
                        <h4>Lista uczni√≥w</h4>
                        <div class="table-container">
                            <table id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>LP</th>
                                        <th>Imiƒô i nazwisko</th>
                                        <th>Klasa</th>
                                        <th>Login</th>
                                        <th>Akcje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamicznie ≈Çadowane -->
                                </tbody>
                            </table>
                        </div>
                        
                        <button class="btn btn-warning" onclick="showLoginPasswords()" style="margin-top: 20px;">
                            üìã Poka≈º loginy i has≈Ça
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sekcja planu lekcji -->
        <div id="timetableSection" class="section" style="display: none;">
            <div class="card">
                <h3>üïí Konstrukcja planu lekcji</h3>
                
                <div class="row">
                    <div class="col">
                        <h4>Ustaw godziny lekcyjne</h4>
                        <div id="lessonHours">
                            <div class="lesson-hour-item">
                                <input type="time" value="08:00"> - <input type="time" value="08:45">
                                <span style="margin-left: 10px;">Lekcja 1</span>
                            </div>
                            <!-- Dodatkowe godziny -->
                        </div>
                        <button class="btn btn-primary" onclick="addLessonHour()">‚ûï Dodaj godzinƒô</button>
                    </div>
                    
                    <div class="col">
                        <h4>Dodaj sale lekcyjne</h4>
                        <input type="text" id="newRoom" placeholder="Nazwa sali (np. 101)">
                        <button class="btn btn-primary" onclick="addClassroom()">‚ûï Dodaj salƒô</button>
                        
                        <div id="classroomsList" style="margin-top: 15px;">
                            <!-- Lista sal -->
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4>Konstruuj plan dla klasy:</h4>
                    <select id="timetableClassSelect" onchange="loadClassTimetable()">
                        <option value="">-- Wybierz klasƒô --</option>
                    </select>
                </div>
                
                <div id="timetableBuilder" style="display: none; margin-top: 20px;">
                    <h4>Plan lekcji dla: <span id="selectedClassName"></span></h4>
                    <div class="table-container">
                        <table class="timetable" id="timetableGrid">
                            <!-- Dynamicznie generowana tabela planu -->
                        </table>
                    </div>
                    <button class="btn btn-success" onclick="saveTimetable()">üíæ Zapisz plan</button>
                </div>
            </div>
        </div>
        
        <!-- Modal do edycji lekcji -->
        <div id="lessonModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeLessonModal()">√ó</span>
                <h3>‚ûï Dodaj lekcjƒô</h3>
                
                <div class="form-group">
                    <label>Przedmiot:</label>
                    <select id="lessonSubject">
                        <!-- Dynamicznie ≈Çadowane -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Nauczyciel:</label>
                    <select id="lessonTeacher">
                        <!-- Dynamicznie ≈Çadowane -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sala:</label>
                    <select id="lessonRoom">
                        <!-- Dynamicznie ≈Çadowane -->
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="saveLesson()">Dodaj lekcjƒô</button>
            </div>
        </div>
        
        <!-- Modal z loginami i has≈Çami -->
        <div id="loginsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('loginsModal')">√ó</span>
                <h3>üìã Loginy i has≈Ça uczni√≥w</h3>
                
                <div class="login-list" id="loginsList">
                    <!-- Dynamicznie ≈Çadowane -->
                </div>
                
                <button class="btn btn-warning" onclick="printLogins()" style="margin-top: 20px;">
                    üñ®Ô∏è Wydrukuj listƒô
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase klient
        const supabaseUrl = 'https://fupfgshptjghdjpkeaee.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1cGZnc2hwdGpnaGRqcGtlYWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDk2MTcsImV4cCI6MjA4NTEyNTYxN30.PO_kVi3YBslUH1GQtfSHduMap_oSNYCsGL9eIhpxYnM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Zmienne globalne
        let currentUser = null;
        let currentSchool = null;
        let currentStep = 1;
        let totalSteps = 5;
        let selectedClassId = null;
        let selectedDay = null;
        let selectedLesson = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üëë Panel Dyrektora - inicjalizacja');
            await checkUserSession();
        });
        
        async function checkUserSession() {
            const isLoggedIn = localStorage.getItem('libruz_is_logged_in');
            const userData = localStorage.getItem('libruz_user');
            
            if (isLoggedIn !== 'true' || !userData) {
                redirectToLogin();
                return;
            }
            
            try {
                currentUser = JSON.parse(userData);
                
                if (currentUser.role !== 'director' && currentUser.role !== 'admin') {
                    showAccessDenied('Tylko dyrektor ma dostƒôp do tego panelu');
                    return;
                }
                
                // Pobierz dane szko≈Çy
                await loadSchoolData();
                
                // Sprawd≈∫ czy trzeba pokazaƒá kreator konfiguracji
                await checkSetupStatus();
                
                // Za≈Çaduj dane
                await loadDashboardData();
                await loadTeachers();
                await loadClasses();
                await loadSubjects();
                
                // Ustaw inicja≈Çy u≈ºytkownika
                document.getElementById('userAvatar').textContent = 
                    (currentUser.first_name?.charAt(0) || '') + (currentUser.last_name?.charAt(0) || '');
                document.getElementById('userName').textContent = 
                    `${currentUser.first_name} ${currentUser.last_name}`;
                
            } catch (error) {
                console.error('B≈ÇƒÖd sesji:', error);
                localStorage.clear();
                redirectToLogin();
            }
        }
        
        async function loadSchoolData() {
            if (!currentUser.school_id) {
                console.error('Brak school_id w profilu u≈ºytkownika');
                return;
            }
            
            const { data: school, error } = await supabase
                .from('schools')
                .select('*')
                .eq('id', currentUser.school_id)
                .single();
            
            if (error) {
                console.error('B≈ÇƒÖd ≈Çadowania szko≈Çy:', error);
                return;
            }
            
            currentSchool = school;
        }
        
        async function checkSetupStatus() {
            // Sprawd≈∫ czy szko≈Ça ma ju≈º skonfigurowane podstawowe elementy
            const { data: teachers } = await supabase
                .from('profiles')
                .select('id')
                .eq('school_id', currentUser.school_id)
                .eq('role', 'teacher');
            
            const { data: classes } = await supabase
                .from('classes')
                .select('id')
                .eq('school_id', currentUser.school_id);
            
            const { data: students } = await supabase
                .from('profiles')
                .select('id')
                .eq('school_id', currentUser.school_id)
                .eq('role', 'student');
            
            // Je≈õli brakuje kt√≥rego≈õ elementu, poka≈º kreator
            if (!teachers?.length || !classes?.length || !students?.length) {
                document.getElementById('setupWizard').style.display = 'block';
                updateWizard();
            }
        }
        
        async function loadDashboardData() {
            // Liczba nauczycieli
            const { data: teachers } = await supabase
                .from('profiles')
                .select('id')
                .eq('school_id', currentUser.school_id)
                .eq('role', 'teacher');
            
            // Liczba klas
            const { data: classes } = await supabase
                .from('classes')
                .select('id')
                .eq('school_id', currentUser.school_id);
            
            // Liczba uczni√≥w
            const { data: students } = await supabase
                .from('profiles')
                .select('id')
                .eq('school_id', currentUser.school_id)
                .eq('role', 'student');
            
            document.getElementById('teachersCount').textContent = teachers?.length || 0;
            document.getElementById('classesCount').textContent = classes?.length || 0;
            document.getElementById('studentsCount').textContent = students?.length || 0;
        }
        
        // ===== KREATOR KONFIGURACJI =====
        function updateWizard() {
            // Aktualizuj kroki
            for (let i = 1; i <= totalSteps; i++) {
                const stepCircle = document.getElementById(`step${i}`);
                if (i < currentStep) {
                    stepCircle.className = 'step-circle completed';
                } else if (i === currentStep) {
                    stepCircle.className = 'step-circle active';
                } else {
                    stepCircle.className = 'step-circle';
                }
            }
            
            // Aktualizuj progress bar
            const progress = (currentStep - 1) / (totalSteps - 1) * 100;
            document.getElementById('setupProgress').style.width = `${progress}%`;
            
            // Za≈Çaduj zawarto≈õƒá kroku
            loadWizardStep();
        }
        
        function loadWizardStep() {
            const content = document.getElementById('wizardContent');
            
            switch(currentStep) {
                case 1:
                    content.innerHTML = `
                        <h4>Krok 1: Dodaj nauczycieli</h4>
                        <p>Dodaj wszystkich nauczycieli, kt√≥rzy bƒôdƒÖ pracowaƒá w szkole.</p>
                        <button class="btn btn-primary" onclick="showSection('teachers')">
                            Przejd≈∫ do zarzƒÖdzania nauczycielami
                        </button>
                        <div style="margin-top: 20px;">
                            <label><input type="checkbox" id="step1Complete"> Zako≈Ñczy≈Çem dodawanie nauczycieli</label>
                        </div>
                    `;
                    break;
                    
                case 2:
                    content.innerHTML = `
                        <h4>Krok 2: Utw√≥rz klasy</h4>
                        <p>Utw√≥rz wszystkie klasy w szkole z ich wychowawcami i przedmiotami.</p>
                        <button class="btn btn-primary" onclick="showSection('classes')">
                            Przejd≈∫ do zarzƒÖdzania klasami
                        </button>
                        <div style="margin-top: 20px;">
                            <label><input type="checkbox" id="step2Complete"> Zako≈Ñczy≈Çem tworzenie klas</label>
                        </div>
                    `;
                    break;
                    
                case 3:
                    content.innerHTML = `
                        <h4>Krok 3: Dodaj uczni√≥w</h4>
                        <p>Dodaj wszystkich uczni√≥w do odpowiednich klas.</p>
                        <button class="btn btn-primary" onclick="showSection('students')">
                            Przejd≈∫ do zarzƒÖdzania uczniami
                        </button>
                        <div style="margin-top: 20px;">
                            <label><input type="checkbox" id="step3Complete"> Zako≈Ñczy≈Çem dodawanie uczni√≥w</label>
                        </div>
                    `;
                    break;
                    
                case 4:
                    content.innerHTML = `
                        <h4>Krok 4: Stw√≥rz plan lekcji</h4>
                        <p>Skonstruuj plan lekcji dla wszystkich klas.</p>
                        <button class="btn btn-primary" onclick="showSection('timetable')">
                            Przejd≈∫ do konstrukcji planu
                        </button>
                        <div style="margin-top: 20px;">
                            <label><input type="checkbox" id="step4Complete"> Zako≈Ñczy≈Çem tworzenie planu lekcji</label>
                        </div>
                    `;
                    break;
                    
                case 5:
                    content.innerHTML = `
                        <h4>üéâ Konfiguracja zako≈Ñczona!</h4>
                        <p>Twoja szko≈Ça jest gotowa do pracy. Mo≈ºesz rozpoczƒÖƒá korzystanie z systemu LIBRUZ.</p>
                        <button class="btn btn-success" onclick="completeSetup()">
                            Zako≈Ñcz konfiguracjƒô
                        </button>
                    `;
                    break;
            }
        }
        
        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                updateWizard();
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizard();
            }
        }
        
        function completeSetup() {
            document.getElementById('setupWizard').style.display = 'none';
            alert('üéâ Konfiguracja szko≈Çy zako≈Ñczona pomy≈õlnie!');
        }
        
        // ===== ZARZƒÑDZANIE NAUCZYCIELAMI =====
        async function loadTeachers() {
            const { data: teachers, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('school_id', currentUser.school_id)
                .eq('role', 'teacher')
                .order('last_name');
            
            if (error) {
                console.error('B≈ÇƒÖd ≈Çadowania nauczycieli:', error);
                return;
            }
            
            const tbody = document.getElementById('teachersTable')?.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            teachers.forEach(teacher => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${teacher.first_name} ${teacher.last_name}</td>
                    <td>${teacher.subjects?.join(', ') || 'Brak'}</td>
                    <td>${teacher.username}</td>
                    <td><span class="badge ${teacher.is_active ? 'badge-success' : 'badge-warning'}">
                        ${teacher.is_active ? 'Aktywny' : 'Nieaktywny'}
                    </span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editTeacher('${teacher.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-warning btn-sm" onclick="resetPassword('${teacher.id}')">üîê</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTeacher('${teacher.id}')">üóëÔ∏è</button>
                    </td>
                `;
            });
            
            // Uzupe≈Çnij select wychowawc√≥w
            const homeroomSelect = document.getElementById('classHomeroom');
            if (homeroomSelect) {
                homeroomSelect.innerHTML = '<option value="">Wybierz wychowawcƒô</option><option value="">Brak wychowawcy</option>';
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = `${teacher.first_name} ${teacher.last_name}`;
                    homeroomSelect.appendChild(option);
                });
            }
        }
        
        function addTeacher(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('teacherFirstName').value;
            const lastName = document.getElementById('teacherLastName').value;
            const email = document.getElementById('teacherEmail').value;
            const subjects = Array.from(document.getElementById('teacherSubjects').selectedOptions)
                .map(opt => opt.value);
            
            // Generuj login
            const username = generateUsername(lastName, 'N');
            const tempPassword = generatePassword();
            
            // Tutaj dodaj logikƒô zapisu do Supabase
            console.log('Dodaj nauczyciela:', { firstName, lastName, email, subjects, username, tempPassword });
            
            // Reset formularza
            e.target.reset();
            document.getElementById('generatedLogin').textContent = username;
            document.getElementById('generatedPassword').textContent = tempPassword;
            
            alert(`Nauczyciel dodany!\nLogin: ${username}\nHas≈Ço: ${tempPassword}`);
        }
        
        // ===== ZARZƒÑDZANIE KLASAMI =====
        async function loadClasses() {
            const { data: classes, error } = await supabase
                .from('classes')
                .select(`
                    *,
                    homeroom_teacher:profiles(first_name, last_name)
                `)
                .eq('school_id', currentUser.school_id)
                .order('level', { ascending: true });
            
            if (error) {
                console.error('B≈ÇƒÖd ≈Çadowania klas:', error);
                return;
            }
            
            const tbody = document.getElementById('classesTable')?.querySelector('tbody');
            const classSelect = document.getElementById('studentClassSelect');
            const timetableSelect = document.getElementById('timetableClassSelect');
            
            if (tbody) tbody.innerHTML = '';
            if (classSelect) classSelect.innerHTML = '<option value="">-- Wybierz klasƒô --</option>';
            if (timetableSelect) timetableSelect.innerHTML = '<option value="">-- Wybierz klasƒô --</option>';
            
            classes.forEach(cls => {
                // Tabela klas
                if (tbody) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${cls.name}</strong></td>
                        <td>${cls.homeroom_teacher ? `${cls.homeroom_teacher.first_name} ${cls.homeroom_teacher.last_name}` : 'Brak'}</td>
                        <td>${cls.student_count || 0}</td>
                        <td>${cls.subjects?.slice(0, 3).join(', ') || 'Brak'}${cls.subjects?.length > 3 ? '...' : ''}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editClass('${cls.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="viewClass('${cls.id}')">üëÅÔ∏è</button>
                        </td>
                    `;
                }
                
                // Selecty
                if (classSelect) {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    classSelect.appendChild(option);
                }
                
                if (timetableSelect) {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    timetableSelect.appendChild(option);
                }
            });
        }
        
        function addClass(e) {
            e.preventDefault();
            
            const level = document.getElementById('classLevel').value;
            const prefix = document.getElementById('classPrefix').value;
            const homeroom = document.getElementById('classHomeroom').value;
            const className = `${level}${prefix ? prefix : ''}`;
            
            // Tutaj dodaj logikƒô zapisu do Supabase
            console.log('Dodaj klasƒô:', { level, prefix, homeroom, className });
            
            alert(`Klasa ${className} dodana pomy≈õlnie!`);
            loadClasses();
            e.target.reset();
        }
        
        // ===== ZARZƒÑDZANIE UCZNIAMI =====
        async function loadClassStudents() {
            const classId = document.getElementById('studentClassSelect').value;
            if (!classId) return;
            
            const addStudentArea = document.getElementById('addStudentArea');
            addStudentArea.innerHTML = `
                <h5>Dodaj ucznia do klasy</h5>
                <div class="row">
                    <div class="col">
                        <input type="text" id="newStudentFirstName" placeholder="Imiƒô">
                    </div>
                    <div class="col">
                        <input type="text" id="newStudentLastName" placeholder="Nazwisko">
                    </div>
                    <div class="col">
                        <button class="btn btn-primary" onclick="addSingleStudent()">‚ûï Dodaj</button>
                    </div>
                </div>
            `;
            
            document.getElementById('bulkAddStudents').style.display = 'block';
        }
        
        function addSingleStudent() {
            const firstName = document.getElementById('newStudentFirstName').value;
            const lastName = document.getElementById('newStudentLastName').value;
            const classId = document.getElementById('studentClassSelect').value;
            
            if (!firstName || !lastName || !classId) {
                alert('Wype≈Çnij wszystkie pola!');
                return;
            }
            
            // Generuj login i has≈Ço
            const username = generateUsername(lastName, 'U');
            const password = generatePassword();
            
            console.log('Dodaj ucznia:', { firstName, lastName, classId, username, password });
            
            // Reset pola
            document.getElementById('newStudentFirstName').value = '';
            document.getElementById('newStudentLastName').value = '';
            
            alert(`Ucze≈Ñ dodany!\nLogin: ${username}\nHas≈Ço: ${password}`);
        }
        
        function bulkAddStudents() {
            const text = document.getElementById('studentsBulk').value;
            const lines = text.split('\n').filter(line => line.trim());
            
            const students = [];
            lines.forEach(line => {
                const parts = line.trim().split(' ');
                if (parts.length >= 2) {
                    const firstName = parts[0];
                    const lastName = parts.slice(1).join(' ');
                    students.push({ firstName, lastName });
                }
            });
            
            console.log('Dodaj wielu uczni√≥w:', students);
            alert(`Dodano ${students.length} uczni√≥w`);
        }
        
        function showLoginPasswords() {
            // Tutaj pobierz uczni√≥w i wy≈õwietl w modal
            document.getElementById('loginsModal').style.display = 'block';
            
            // Przyk≈Çadowe dane
            const logins = [
                { name: 'Jan Kowalski', login: 'kowalskiU', password: 'Uczen2024!' },
                { name: 'Anna Nowak', login: 'nowakU', password: 'Nowak2024!' }
            ];
            
            const list = document.getElementById('loginsList');
            list.innerHTML = '';
            
            logins.forEach(login => {
                const div = document.createElement('div');
                div.className = 'login-item';
                div.innerHTML = `
                    <div>
                        <strong>${login.name}</strong><br>
                        <small>Login: ${login.login}</small>
                    </div>
                    <div>
                        <code>${login.password}</code>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        // ===== PLAN LEKCJI =====
        function addLessonHour() {
            const container = document.getElementById('lessonHours');
            const count = container.children.length + 1;
            
            const div = document.createElement('div');
            div.className = 'lesson-hour-item';
            div.innerHTML = `
                <input type="time" value="08:00"> - <input type="time" value="08:45">
                <span style="margin-left: 10px;">Lekcja ${count}</span>
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()" style="margin-left: 10px;">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }
        
        function addClassroom() {
            const roomName = document.getElementById('newRoom').value;
            if (!roomName) return;
            
            const container = document.getElementById('classroomsList');
            const div = document.createElement('div');
            div.className = 'subject-tag';
            div.innerHTML = `
                üè´ ${roomName}
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #999; margin-left: 5px;">√ó</button>
            `;
            container.appendChild(div);
            
            document.getElementById('newRoom').value = '';
        }
        
        function loadClassTimetable() {
            const classId = document.getElementById('timetableClassSelect').value;
            if (!classId) {
                document.getElementById('timetableBuilder').style.display = 'none';
                return;
            }
            
            selectedClassId = classId;
            const className = document.getElementById('timetableClassSelect').selectedOptions[0].text;
            document.getElementById('selectedClassName').textContent = className;
            document.getElementById('timetableBuilder').style.display = 'block';
            
            // Generuj tabelƒô planu
            generateTimetableGrid();
        }
        
        function generateTimetableGrid() {
            const days = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];
            const hours = 8; // 8 lekcji
            
            const table = document.getElementById('timetableGrid');
            table.innerHTML = '';
            
            // Nag≈Ç√≥wek
            let thead = '<tr><th>Lekcja</th>';
            days.forEach(day => {
                thead += `<th>${day}</th>`;
            });
            thead += '</tr>';
            table.innerHTML = thead;
            
            // Wiersze z lekcjami
            for (let i = 1; i <= hours; i++) {
                let row = `<tr><td style="background: #f8f9fa; font-weight: bold;">${i}</td>`;
                
                days.forEach(day => {
                    row += `<td class="lesson-cell empty" onclick="openLessonModal('${day}', ${i})">+</td>`;
                });
                
                row += '</tr>';
                table.innerHTML += row;
            }
        }
        
        function openLessonModal(day, lesson) {
            selectedDay = day;
            selectedLesson = lesson;
            document.getElementById('lessonModal').style.display = 'block';
            
            // Tutaj za≈Çaduj przedmioty, nauczycieli i sale dla danej klasy
        }
        
        function closeLessonModal() {
            document.getElementById('lessonModal').style.display = 'none';
        }
        
        function saveLesson() {
            const subject = document.getElementById('lessonSubject').value;
            const teacher = document.getElementById('lessonTeacher').value;
            const room = document.getElementById('lessonRoom').value;
            
            console.log('Zapisz lekcjƒô:', { day: selectedDay, lesson: selectedLesson, subject, teacher, room });
            
            // Aktualizuj kom√≥rkƒô w tabeli
            const cells = document.querySelectorAll('.lesson-cell');
            cells.forEach(cell => {
                if (cell.getAttribute('onclick')?.includes(`${selectedDay}', ${selectedLesson}`)) {
                    cell.className = 'lesson-cell has-lesson';
                    cell.innerHTML = `
                        <strong>${subject}</strong><br>
                        <small>${teacher}</small><br>
                        <small>${room}</small>
                        <button onclick="removeLesson(this)" style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: #dc3545;">√ó</button>
                    `;
                    cell.onclick = null;
                }
            });
            
            closeLessonModal();
        }
        
        function removeLesson(button) {
            const cell = button.parentElement;
            cell.className = 'lesson-cell empty';
            cell.innerHTML = '+';
            cell.onclick = function() {
                openLessonModal(selectedDay, selectedLesson);
            };
        }
        
        // ===== POMOCNICZE FUNKCJE =====
        function generateUsername(lastName, rolePrefix) {
            const cleanLastName = lastName.toLowerCase()
                .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, '')
                .replace(/[^a-z]/g, '')
                .substring(0, 8);
            return cleanLastName + rolePrefix;
        }
        
        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%';
            let password = '';
            for (let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }
        
        function showSection(sectionId) {
            // Ukryj wszystkie sekcje
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Poka≈º wybranƒÖ sekcjƒô
            document.getElementById(`${sectionId}Section`).style.display = 'block';
            
            // Aktualizuj menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Znajd≈∫ odpowiedni element menu i ustaw jako aktywny
            const menuItems = document.querySelectorAll('.menu-item');
            for (let item of menuItems) {
                if (item.textContent.includes(getSectionName(sectionId))) {
                    item.classList.add('active');
                    break;
                }
            }
        }
        
        function getSectionName(sectionId) {
            const names = {
                'dashboard': 'Pulpit',
                'teachers': 'Nauczyciele',
                'classes': 'Klasy',
                'students': 'Uczniowie',
                'timetable': 'Plan lekcji',
                'subjects': 'Przedmioty',
                'messages': 'Wiadomo≈õci',
                'settings': 'Ustawienia'
            };
            return names[sectionId] || sectionId;
        }
        
        function logout() {
            localStorage.removeItem('libruz_is_logged_in');
            localStorage.removeItem('libruz_user');
            window.location.href = 'index.html';
        }
        
        function redirectToLogin() {
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
        function showAccessDenied(message) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 100px 20px;">
                    <h2 style="color: #dc3545;">‚õî ${message}</h2>
                    <button onclick="logout()" style="margin-top: 20px; padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Wr√≥ƒá do logowania
                    </button>
                </div>
            `;
        }
        
        // Zamknij modal po klikniƒôciu poza nim
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        };
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Inicjalizacja
        showSection('dashboard');
    </script>
</body>
</html>
