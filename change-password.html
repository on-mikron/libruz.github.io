<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê LIBRUZ - Zmiana has≈Ça</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .password-requirements {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }
        
        .requirement .icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .requirement.valid .icon {
            background: #2e7d32;
            color: white;
        }
        
        .requirement.invalid .icon {
            background: #ff3b30;
            color: white;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="logo">
                <h1>üîê LIBRUZ</h1>
                <p class="subtitle">Ustaw nowe has≈Ço</p>
            </div>
            
            <div class="alert" id="alert" style="display: none;"></div>
            
            <form id="passwordForm">
                <div class="form-group">
                    <label for="newPassword">Nowe has≈Ço:</label>
                    <input type="password" id="newPassword" required minlength="8">
                    <div class="password-requirements" id="passwordRequirements">
                        <!-- Zostanie wype≈Çnione przez JavaScript -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Potwierd≈∫ has≈Ço:</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span id="btnText">üíæ Zapisz nowe has≈Ço</span>
                </button>
            </form>
            
            <div class="login-footer">
                <p>Po zmianie has≈Ça zostaniesz przekierowany do panelu</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Strona zmiany has≈Ça');
            
            // Sprawd≈∫ czy u≈ºytkownik ma dostƒôp
            const tempUser = localStorage.getItem('libruz_temp_user');
            if (!tempUser) {
                console.error('‚ùå Brak uprawnie≈Ñ do zmiany has≈Ça');
                window.location.href = 'index.html';
                return;
            }
            
            const user = JSON.parse(tempUser);
            console.log('üë§ U≈ºytkownik wymaga zmiany has≈Ça:', user.email);
            
            // Elementy DOM
            const form = document.getElementById('passwordForm');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const alertDiv = document.getElementById('alert');
            const requirementsDiv = document.getElementById('passwordRequirements');
            
            // Wy≈õwietl wymagania dotyczƒÖce has≈Ça
            displayPasswordRequirements();
            
            // Walidacja has≈Ça w czasie rzeczywistym
            newPasswordInput.addEventListener('input', validatePassword);
            
            // Obs≈Çuga formularza
            form.addEventListener('submit', handlePasswordChange);
            
            function displayPasswordRequirements() {
                requirementsDiv.innerHTML = `
                    <div class="requirement invalid" id="reqLength">
                        <div class="icon">!</div>
                        <span>Minimum 8 znak√≥w</span>
                    </div>
                    <div class="requirement invalid" id="reqLowercase">
                        <div class="icon">!</div>
                        <span>Co najmniej 1 ma≈Ça litera</span>
                    </div>
                    <div class="requirement invalid" id="reqUppercase">
                        <div class="icon">!</div>
                        <span>Co najmniej 1 du≈ºa litera</span>
                    </div>
                    <div class="requirement invalid" id="reqNumber">
                        <div class="icon">!</div>
                        <span>Co najmniej 1 cyfra</span>
                    </div>
                `;
            }
            
            function validatePassword() {
                const password = newPasswordInput.value;
                
                // Sprawd≈∫ wymagania
                const hasLength = password.length >= 8;
                const hasLowercase = /[a-z]/.test(password);
                const hasUppercase = /[A-Z]/.test(password);
                const hasNumber = /\d/.test(password);
                
                // Aktualizuj wy≈õwietlanie wymaga≈Ñ
                updateRequirement('reqLength', hasLength);
                updateRequirement('reqLowercase', hasLowercase);
                updateRequirement('reqUppercase', hasUppercase);
                updateRequirement('reqNumber', hasNumber);
                
                // Sprawd≈∫ czy wszystkie wymagania sƒÖ spe≈Çnione
                const isValid = hasLength && hasLowercase && hasUppercase && hasNumber;
                submitBtn.disabled = !isValid;
                
                return isValid;
            }
            
            function updateRequirement(elementId, isValid) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.className = `requirement ${isValid ? 'valid' : 'invalid'}`;
                const icon = element.querySelector('.icon');
                icon.textContent = isValid ? '‚úì' : '!';
            }
            
            async function handlePasswordChange(event) {
                event.preventDefault();
                
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                // Walidacja
                if (!validatePassword()) {
                    showAlert('Has≈Ço nie spe≈Çnia wszystkich wymaga≈Ñ', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showAlert('Has≈Ça nie sƒÖ identyczne', 'error');
                    return;
                }
                
                // Zmie≈Ñ stan przycisku
                submitBtn.disabled = true;
                btnText.textContent = '‚åõ Zmieniam has≈Ço...';
                
                try {
                    console.log('üîê Zmiana has≈Ça dla:', user.email);
                    
                    // 1. Zmie≈Ñ has≈Ço w Supabase Auth
                    const { error: updateError } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (updateError) throw updateError;
                    
                    console.log('‚úÖ Has≈Ço zmienione w Auth');
                    
                    // 2. Zaktualizuj profil w bazie
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .update({
                            temporary_password: false,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', user.id);
                    
                    if (profileError) throw profileError;
                    
                    console.log('‚úÖ Profil zaktualizowany');
                    
                    // 3. Pobierz zaktualizowany profil
                    const { data: updatedProfile, error: fetchError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    // 4. Zapisz nowe dane i usu≈Ñ tymczasowe
                    localStorage.removeItem('libruz_temp_user');
                    localStorage.setItem('libruz_user', JSON.stringify(updatedProfile));
                    
                    showAlert('‚úÖ Has≈Ço zmienione pomy≈õlnie! Przekierowujƒô...', 'success');
                    
                    // 5. Przekieruj do odpowiedniego dashboardu
                    setTimeout(() => {
                        redirectByRole(updatedProfile);
                    }, 2000);
                    
                } catch (error) {
                    console.error('üí• B≈ÇƒÖd zmiany has≈Ça:', error);
                    showAlert('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
                    
                    // Przywr√≥ƒá przycisk
                    submitBtn.disabled = false;
                    btnText.textContent = 'üíæ Zapisz nowe has≈Ço';
                }
            }
            
            function showAlert(message, type) {
                if (!alertDiv) return;
                
                alertDiv.textContent = message;
                alertDiv.className = 'alert alert-' + type;
                alertDiv.style.display = 'flex';
                
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, type === 'success' ? 3000 : 5000);
            }
            
            function redirectByRole(profile) {
                let dashboardUrl = 'dashboard.html';
                
                switch(profile.role) {
                    case 'admin':
                        dashboardUrl = 'admin-dashboard.html';
                        break;
                    case 'director':
                    case 'vice_director':
                        dashboardUrl = 'director-dashboard.html';
                        break;
                    case 'teacher':
                        dashboardUrl = 'teacher-dashboard.html';
                        break;
                    case 'student':
                        dashboardUrl = 'student-dashboard.html';
                        break;
                    case 'parent':
                        dashboardUrl = 'parent-dashboard.html';
                        break;
                    default:
                        console.warn('Nieznana rola:', profile.role);
                }
                
                console.log('üìç Przekierowanie do:', dashboardUrl);
                window.location.href = dashboardUrl;
            }
        });
    </script>
</body>
</html>
