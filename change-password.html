<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIBRUZ - Zmiana has≈Ça</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .container { max-width: 500px; margin: 50px auto; }
        .info-box { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h1>üîê Ustaw nowe has≈Ço</h1>
            
            <div class="info-box">
                <strong>To Twoje pierwsze logowanie!</strong><br>
                Ustaw w≈Çasne, bezpieczne has≈Ço i dane osobowe.
            </div>
            
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="firstName">Imiƒô:</label>
                    <input type="text" id="firstName" required placeholder="Twoje imiƒô">
                </div>
                
                <div class="form-group">
                    <label for="lastName">Nazwisko:</label>
                    <input type="text" id="lastName" required placeholder="Twoje nazwisko">
                </div>
                
                <div class="form-group">
                    <label for="newPassword">Nowe has≈Ço:</label>
                    <input type="password" id="newPassword" required 
                           placeholder="Minimum 8 znak√≥w" minlength="8">
                    <div class="password-requirements">
                        Wymagane: minimum 8 znak√≥w, wielka litera, cyfra, znak specjalny
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Potwierd≈∫ has≈Ço:</label>
                    <input type="password" id="confirmPassword" required 
                           placeholder="Powt√≥rz has≈Ço">
                </div>
                
                <button type="button" id="saveButton" class="btn btn-primary">
                    üíæ Zapisz i kontynuuj
                </button>
                
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Strona zmiany has≈Ça za≈Çadowana');
            
            const saveButton = document.getElementById('saveButton');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const errorMessage = document.getElementById('errorMessage');
            
            // Sprawd≈∫ czy u≈ºytkownik ma dostƒôp do tej strony
            const tempUser = JSON.parse(localStorage.getItem('libruz_temp_user'));
            
            if (!tempUser) {
                console.log('‚ùå Brak uprawnie≈Ñ - przekierowujƒô do logowania');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('‚úÖ U≈ºytkownik wymaga zmiany has≈Ça:', tempUser.email);
            
            // Obs≈Çuga przycisku zapisu
            saveButton.addEventListener('click', async function() {
                console.log('üíæ Rozpoczynam zmianƒô has≈Ça...');
                
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                // Walidacja
                if (!firstName || !lastName) {
                    showError('‚ö†Ô∏è Podaj imiƒô i nazwisko!');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showError('‚ùå Has≈Ço musi mieƒá minimum 8 znak√≥w!');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showError('‚ùå Has≈Ça nie sƒÖ identyczne!');
                    return;
                }
                
                // Sprawd≈∫ si≈Çƒô has≈Ça (opcjonalne)
                if (!isStrongPassword(newPassword)) {
                    showError('‚ùå Has≈Ço za s≈Çabe! U≈ºyj wielkiej litery, cyfry i znaku specjalnego.');
                    return;
                }
                
                // Zmie≈Ñ stan przycisku
                saveButton.innerHTML = '‚åõ Zapisujƒô...';
                saveButton.disabled = true;
                
                try {
                    console.log('üîÑ Aktualizujƒô has≈Ço w Supabase...');
                    
                    // 1. Zmie≈Ñ has≈Ço w Supabase Auth
                    const { error: updateError } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (updateError) throw updateError;
                    
                    console.log('‚úÖ Has≈Ço zmienione w Auth');
                    
                    // 2. Zaktualizuj profil w bazie
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .update({
                            first_name: firstName,
                            last_name: lastName,
                            temporary_password: false,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', tempUser.id);
                    
                    if (profileError) throw profileError;
                    
                    console.log('‚úÖ Profil zaktualizowany');
                    
                    // 3. Pobierz zaktualizowany profil
                    const { data: updatedProfile, error: fetchError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', tempUser.id)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    // 4. Zapisz nowe dane
                    localStorage.removeItem('libruz_temp_user');
                    localStorage.setItem('libruz_user', JSON.stringify(updatedProfile));
                    
                    // 5. Sukces i przekierowanie
                    showSuccess('‚úÖ Has≈Ço zmienione! Witaj ' + firstName + ' ' + lastName);
                    
                    setTimeout(() => {
                        // Przekieruj wed≈Çug roli
                        switch(updatedProfile.role) {
                            case 'admin':
                                window.location.href = 'admin-dashboard.html';
                                break;
                            case 'director':
                                window.location.href = 'director-dashboard.html';
                                break;
                            case 'teacher':
                                window.location.href = 'teacher-dashboard.html';
                                break;
                            case 'student':
                                window.location.href = 'student-dashboard.html';
                                break;
                            default:
                                window.location.href = 'index.html';
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('üí• B≈ÇƒÖd zmiany has≈Ça:', error);
                    showError('‚ùå B≈ÇƒÖd: ' + error.message);
                    
                    // Przywr√≥ƒá przycisk
                    saveButton.innerHTML = 'üíæ Zapisz i kontynuuj';
                    saveButton.disabled = false;
                }
            });
            
            // Funkcja sprawdzajƒÖca si≈Çƒô has≈Ça
            function isStrongPassword(password) {
                const hasUpperCase = /[A-Z]/.test(password);
                const hasLowerCase = /[a-z]/.test(password);
                const hasNumbers = /\d/.test(password);
                const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                
                return password.length >= 8 && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;
            }
            
            // Funkcje komunikat√≥w
            function showError(message) {
                console.error('üö®', message);
                
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#ffeaea';
                errorMessage.style.color = '#ff3b30';
                errorMessage.style.borderLeftColor = '#ff3b30';
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
            
            function showSuccess(message) {
                console.log('‚úÖ', message);
                
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#e8f5e9';
                errorMessage.style.color = '#2e7d32';
                errorMessage.style.borderLeftColor = '#2e7d32';
            }
            
            console.log('‚úÖ Strona zmiany has≈Ça gotowa');
        });
    </script>
</body>
</html>
